{% extends "base.html" %}

{% block sidebar %}
<div class="sidebar-content">
    <!-- Session Controls -->
    <div class="d-grid gap-2 mb-2">
        <button class="btn btn-primary btn-sm" onclick="createNewSession()">
            <i class="fas fa-plus me-1"></i> New Session
        </button>
        <button class="btn btn-outline-danger btn-sm" onclick="endCurrentSession()" id="endSessionBtn" disabled>
            <i class="fas fa-times me-1"></i> End Session
        </button>
    </div>

    <hr class="my-2">

    <!-- Sessions List -->
    <h6 class="sidebar-heading px-2 mb-2 text-muted">
        <span>üìÇ Sessions</span>
    </h6>
    <div id="sessionsList" class="list-group list-group-flush sessions-scroll">
        {% if all_sessions %}
            {% for sess in all_sessions %}
            <a href="#" class="list-group-item list-group-item-action session-item" 
               data-session-id="{{ sess.session_id }}"
               onclick="loadSession('{{ sess.session_id }}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ sess.title[:30] }}...</h6>
                    <small>{{ sess.last_updated[:10] }}</small>
                </div>
                <small class="text-muted">
                    üí¨ {{ sess.query_count }} queries
                </small>
            </a>
            {% endfor %}
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p>No sessions yet</p>
            </div>
        {% endif %}
    </div>

    <!-- Refresh Button - At Bottom -->
    <div class="sidebar-footer">
        <button class="btn btn-outline-secondary btn-sm w-100" onclick="refreshSessions()">
            <i class="fas fa-sync me-1"></i> Refresh
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Alert Area -->
<div id="alertArea"></div>

<!-- Analyzer Status - Compact -->
{% if analyzer_info.ready %}
<div class="alert alert-success border-0 shadow-sm mb-2 py-2">
    <div class="d-flex align-items-center">
        <small class="text-muted">
            <i class="fas fa-check-circle text-success me-1"></i>
            <strong>System Ready</strong> ¬∑ 
            üìÅ <strong>{{ analyzer_info.image_count }}</strong> images ¬∑ 
            ‚öôÔ∏è <strong>{{ analyzer_info.max_workers }}</strong> workers
        </small>
    </div>
</div>
{% else %}
<div class="alert alert-warning border-0 shadow-sm mb-2 py-2">
    <small>
        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
        <strong>System Not Initialized</strong> - Please restart the server
    </small>
</div>
{% endif %}

<!-- Current Session Info - Compact -->
<div id="currentSessionInfo" class="alert alert-info border-0 shadow-sm mb-2 py-2" style="display: none;">
    <small>
        <strong>üìù Current Session:</strong> <span id="sessionTitle"></span>
        <span class="float-end">
            üí¨ <span id="sessionQueryCount">0</span> queries
        </span>
    </small>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">
            <i class="fas fa-comments"></i> Chat
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button">
            <i class="fas fa-chart-bar"></i> Full Results
        </button>
    </li>
</ul>

<div class="tab-content" id="myTabContent">
    <!-- Chat Tab -->
    <div class="tab-pane fade show active" id="chat" role="tabpanel">
        <div class="chat-container mt-3">
            <!-- Conversation History -->
            <div id="conversationHistory" class="mb-4">
                {% if current_session and current_session.conversation.queries %}
                    {% for query in current_session.conversation.queries %}
                        <!-- User Message -->
                        <div class="message user-message">
                            <div class="message-header">
                                <i class="fas fa-user"></i> You
                                <span class="message-time">{{ query.timestamp }}</span>
                            </div>
                            <div class="message-body">{{ query.user_query }}</div>
                        </div>

                        <!-- AI Response -->
                        <div class="message ai-message">
                            <div class="message-header">
                                <i class="fas fa-robot"></i> AI Assistant
                                {% if query.results.is_contextual %}
                                    <span class="badge bg-info">üîó Contextual</span>
                                {% else %}
                                    <span class="badge bg-primary">üîç Full Analysis</span>
                                {% endif %}
                                <span class="message-time">{{ query.timestamp }}</span>
                            </div>
                            <div class="message-body">
                                {{ query.summary }}
                            </div>
                            
                            <!-- View Details Button -->
                            <button class="btn btn-sm btn-outline-primary mt-2" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#details{{ loop.index }}">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            
                            <!-- Collapsible Details -->
                            <div class="collapse mt-3" id="details{{ loop.index }}">
                                <div class="card card-body">
                                    <h6>üìä Statistics</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="stat-card bg-primary">
                                                <div class="stat-value">{{ query.results.total_images }}</div>
                                                <div class="stat-label">Images</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card bg-success">
                                                <div class="stat-value">{{ query.results.matches_found }}</div>
                                                <div class="stat-label">Matches</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card bg-warning">
                                                <div class="stat-value">{{ query.results.unique_locations }}</div>
                                                <div class="stat-label">Locations</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card bg-info">
                                                <div class="stat-value">
                                                    {{ ((query.results.matches_found / query.results.total_images) * 100)|round }}%
                                                </div>
                                                <div class="stat-label">Match Rate</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6>üéØ Full Answer</h6>
                                    <div class="alert alert-light">
                                        <pre style="white-space: pre-wrap;">{{ query.results.final_answer }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted p-5">
                        <i class="fas fa-comment-dots fa-3x mb-3"></i>
                        <h5>Start a Conversation!</h5>
                        <p>Create a session and ask your first question below.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Query Input Footer - Inside Chat Area -->
            <div class="chat-query-footer">
                <div class="row g-2 align-items-center">
                    <div class="col-md-8">
                        <textarea class="form-control form-control-sm" id="queryInput" rows="1" 
                                  placeholder="Ask a question... (Ctrl+Enter to send)"></textarea>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary btn-sm w-100" onclick="sendQuery()" id="sendBtn">
                            <i class="fas fa-paper-plane me-1"></i>Send
                        </button>
                    </div>
                    <div class="col-md-1">
                        <div class="form-check form-check-sm">
                            <input class="form-check-input" type="checkbox" id="batchMode" title="Batch Mode">
                            <label class="form-check-label small" for="batchMode">üì¶</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Tab -->
    <div class="tab-pane fade" id="results" role="tabpanel">
        <div class="mt-3">
            <div id="resultsArea" class="text-center text-muted p-5">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <h5>No Results Yet</h5>
                <p>Run an analysis or select from history to see results here.</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Analyzing images...</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentSessionId = null;

// Update worker count display
document.getElementById('maxWorkers').addEventListener('input', function() {
    document.getElementById('workerValue').textContent = this.value;
});

// Example query click
document.querySelectorAll('.example-query').forEach(el => {
    el.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('queryInput').value = this.dataset.query;
    });
});
</script>
{% endblock %}

